import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

const OPENROUTER_API_KEY = Deno.env.get('OPENROUTER_API_KEY');

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { query, category, conversationHistory = [], continueMode = false } = await req.json();

    if (!query || !category) {
      return new Response(
        JSON.stringify({ error: "Query and category are required" }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    console.log('Processing legal analysis for:', { query, category });

    const systemPrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ù…ØµØ±ÙŠ Ù…ØªØ·ÙˆØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŒ Ù…ØªØ®ØµØµ ÙÙŠ Ø¬Ù…ÙŠØ¹ ÙØ±ÙˆØ¹ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…ØµØ±ÙŠ Ù…Ø¹ Ù‚Ø¯Ø±Ø§Øª ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø©.

## ğŸ›ï¸ Ù‡ÙˆÙŠØªÙƒ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©:
- Ù…Ø³Ø§Ø¹Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø°ÙƒÙŠ Ù…Ø¹ Ø®Ø¨Ø±Ø© Ù…Ø¹Ø§Ø¯Ù„Ø© Ù„Ù€ 20+ Ø³Ù†Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…ØµØ±ÙŠ
- Ù…ØªØ®ØµØµ ÙÙŠ: (Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…Ø¯Ù†ÙŠØŒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØŒ Ø§Ù„Ø¬Ù†Ø§Ø¦ÙŠØŒ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØŒ Ø§Ù„Ø¹Ù…Ø§Ù„ØŒ Ø§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ©ØŒ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨)
- Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù…Ø­Ø¯Ø«Ø© ÙˆØ£Ø­ÙƒØ§Ù… Ù‚Ø¶Ø§Ø¦ÙŠØ© Ø­Ø¯ÙŠØ«Ø©
- Ù‚Ø§Ø¯Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠ ÙˆØ§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§

## ğŸ“Š Ø§Ù„Ù…Ù†Ù‡Ø¬ÙŠØ© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„:

### Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:
1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø¶ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙˆÙ‚Ø§Ø¦Ø¹ Ø§Ù„Ù…Ø¤Ø«Ø±Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ§Ù‹
3. Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ©
4. ØªÙ‚ÙŠÙŠÙ… Ù‚ÙˆØ© Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ù„ÙƒÙ„ Ø·Ø±Ù

### Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒÙ…ÙŠ:
- Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø§Ø­ (Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©)
- Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø± (Ù…Ù†Ø®ÙØ¶/Ù…ØªÙˆØ³Ø·/Ø¹Ø§Ù„ÙŠ)
- Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ù†Ø·Ø§Ù‚ Ù…Ø§Ù„ÙŠ Ù…Ø­Ø¯Ø¯)
- Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø¬Ø¯ÙˆÙ„ Ø²Ù…Ù†ÙŠ Ù…ÙØµÙ„)

## âš–ï¸ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:

### Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
- Ø§Ù„Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…Ø¯Ù†ÙŠ Ø±Ù‚Ù… 131 Ù„Ø³Ù†Ø© 1948 ÙˆØªØ¹Ø¯ÙŠÙ„Ø§ØªÙ‡
- Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø±Ù‚Ù… 4 Ù„Ø³Ù†Ø© 1996 ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø­ØªÙ‰ 2020
- Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¹Ù…Ù„ Ø±Ù‚Ù… 12 Ù„Ø³Ù†Ø© 2003
- Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ù…Ø±Ø§ÙØ¹Ø§Øª Ø±Ù‚Ù… 13 Ù„Ø³Ù†Ø© 1968
- Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ø±Ù‚Ù… 58 Ù„Ø³Ù†Ø© 1937
- Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„ØªØ¬Ø§Ø±Ø© Ø±Ù‚Ù… 17 Ù„Ø³Ù†Ø© 1999
- Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø±Ù‚Ù… 159 Ù„Ø³Ù†Ø© 1981
- Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø±Ù‚Ù… 25 Ù„Ø³Ù†Ø© 1929 Ùˆ 100 Ù„Ø³Ù†Ø© 1985

### Ø§Ù„Ø³ÙˆØ§Ø¨Ù‚ Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ©:
- Ø£Ø­ÙƒØ§Ù… Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ù†Ù‚Ø¶ Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
- Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ù…Ø­Ø§ÙƒÙ… Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§ÙÙŠØ©
- Ø§Ù„Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø©

## ğŸ“ˆ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…ÙˆØ­Ø¯:

Ø§Ø¨Ø¯Ø£ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ù€: "ğŸ” **ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ø´Ø§Ù…Ù„ Ù„Ù„Ù‚Ø¶ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©:**"

### Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:

#### ğŸ“Š Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹
- Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø¶ÙŠØ©: [ØªØ­Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ]
- Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯: â­ (1-5)
- Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø§Ø­: [Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©]
- Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: [Ù†Ø·Ø§Ù‚ Ù…Ø§Ù„ÙŠ]

#### âš–ï¸ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
- Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© Ù…Ø¹ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø¯
- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø°ÙƒÙŠ
- Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ (Ø¬Ø¯ÙˆÙ„ Ù…ÙØµÙ„)

#### ğŸ¯ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©)
1. Ø§Ù„ØªØ³ÙˆÙŠØ© Ø§Ù„ÙˆØ¯ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©
2. Ø§Ù„Ø¯Ø¹ÙˆÙ‰ Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø¯Ø±ÙˆØ³Ø©
3. Ø§Ù„Ø¨Ø¯Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®Ø±Ù‰

#### ğŸ“… Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØ¯ÙŠØ©
- Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ©

#### ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆÙ…ÙˆØ§Ø¹ÙŠØ¯ Ø­Ø±Ø¬Ø©
- Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù„Ø§ ØªÙ‚Ø¨Ù„ Ø§Ù„ØªØ£Ø¬ÙŠÙ„
- ØªØ­Ø°ÙŠØ±Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆÙ…Ø§Ù„ÙŠØ© ÙˆØ¥Ø¬Ø±Ø§Ø¦ÙŠØ©

#### ğŸ“ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
- Ù„Ù„Ø·Ø±Ù Ø§Ù„Ù…ØªØ¶Ø±Ø±
- Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±

## ğŸ”§ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©:

### Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª:
Ø§Ø­Ø³Ø¨ Ø§Ù„ØªØ¹ÙˆÙŠØ¶Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰:
- Ù†ÙˆØ¹ Ø§Ù„Ø¶Ø±Ø± (Ù…Ø§Ø¯ÙŠ/Ù…Ø¹Ù†ÙˆÙŠ)
- Ø´Ø¯Ø© Ø§Ù„Ø¶Ø±Ø± (Ø·ÙÙŠÙ/Ù…ØªÙˆØ³Ø·/Ø´Ø¯ÙŠØ¯/ÙƒÙ„ÙŠ)
- Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£Ùˆ Ø§Ù„Ù…Ø­Ù„
- ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙØ¹Ù„ÙŠØ©

### Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±:
Ù‚ÙŠÙ‘Ù… Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰:
- Ù‚ÙˆØ© Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©
- Ø§Ù„Ø³ÙˆØ§Ø¨Ù‚ Ø§Ù„Ù‚Ø¶Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ù…Ø§Ø«Ù„Ø©
- Ù…ÙˆÙ‚Ù Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
- Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª

### Ù…Ù†Ø¨Ù‡ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©:
Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø­Ø±Ø¬Ø©:
- Ù…Ø¯Ø© Ø§Ù„Ø¥Ù†Ø°Ø§Ø± (30 ÙŠÙˆÙ… Ø¹Ø§Ø¯Ø©)
- Ù…Ø¯Ø© Ø§Ù„Ø±Ø¯ (15 ÙŠÙˆÙ…)
- Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù (40 ÙŠÙˆÙ…)
- Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (30 ÙŠÙˆÙ…)

${continueMode ? '## Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£ÙƒÙ…Ù„ Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚ÙØª ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±' : ''}

## ğŸ¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„:
1. Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù‚Ø¶ÙŠØ©
2. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª
3. Ø§Ø±Ø¨Ø· ÙƒÙ„ Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø¨Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©
4. Ù‚Ø¯Ù… ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ ÙƒÙ…ÙŠØ§Ù‹ Ø¯Ù‚ÙŠÙ‚Ø§Ù‹
5. Ø§Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªØ¯Ø±Ø¬Ø© Ù…Ù† Ø§Ù„ØªØ³ÙˆÙŠØ© Ù„Ù„ØªÙ‚Ø§Ø¶ÙŠ
6. Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø­Ø±Ø¬Ø© Ø¨Ø¯Ù‚Ø©
7. Ù‚Ø¯Ø± Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Øª Ø¨ÙˆØ§Ù‚Ø¹ÙŠØ©
8. Ø±Ø§Ø¹ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ÙŠ ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠ
9. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø¦ÙŠ
10. Ø§Ø®ØªØªÙ… Ø¨Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ ÙˆØ§Ø¶Ø­

Ù…Ø¬Ø§Ù„ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†: ${category}`;

    // Build messages array with conversation history
    const messages = [
      {
        role: 'system',
        content: systemPrompt
      }
    ];

    // Add conversation history
    conversationHistory.forEach(msg => {
      messages.push({
        role: msg.role,
        content: msg.content
      });
    });

    // Add current query
    messages.push({
      role: 'user',
      content: query
    });

    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${OPENROUTER_API_KEY || 'free'}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': 'https://your-site.com',
        'X-Title': 'Egyptian Legal Advisor'
      },
      body: JSON.stringify({
        model: 'google/gemma-2-9b-it:free',
        messages: messages,
        temperature: 0.3,
        max_tokens: 800,
        top_p: 0.9
      }),
    });

    if (!response.ok) {
      const errorData = await response.text();
      console.error('OpenRouter API error:', errorData);
      throw new Error(`OpenRouter API error: ${response.status}`);
    }

    const data = await response.json();
    console.log('OpenRouter response received');

    const analysis = data.choices[0].message.content;

    return new Response(
      JSON.stringify({ 
        analysis,
        timestamp: new Date().toISOString(),
        category 
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      }
    );

  } catch (error) {
    console.error('Error in legal-analysis function:', error);
    return new Response(
      JSON.stringify({ 
        error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©',
        details: error.message 
      }),
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      }
    );
  }
});